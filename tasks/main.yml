---
# tasks file for oozie
- name: install oozie (Ubuntu)
  sudo: yes
  sudo_user: root
  apt: pkg={{ item }} state=present
  with_items:
    - mapr-oozie-{{oozie_version}}.{{oozie_build}}
  when: ansible_distribution == 'Ubuntu' 
  notify: reconfigure roles
  environment: proxy_env

- name: install oozie (RedHat)
  sudo: yes
  sudo_user: root
  yum: pkg={{ item }} state=present
  with_items:
    - mapr-oozie-{{oozie_version}}.{{oozie_build}}
  when: ansible_distribution in ('CentOS','RedHat','Amazon')
  notify: reconfigure roles
  environment: proxy_env

- name: get zookeeper ensemble
  sudo: yes
  sudo_user: '{{mapr_admin_username}}'
  command: maprcli node listzookeepers -noheader
  register: zookeepers
  changed_when: false

- name: update oozie.services.ext
  sudo: yes
  sudo_user: '{{mapr_admin_username}}'
  hadoop_properties:
    file: "/opt/mapr/oozie/oozie-{{oozie_version}}/conf/oozie-site.xml"
    name: "oozie.services.ext"
    value: "org.apache.oozie.service.ZKLocksService, org.apache.oozie.service.ZKXLogStreamingService, org.apache.oozie.service.ZKJobsConcurrencyService"
  notify: restart oozie

- name: update oozie with ZK info
  sudo: yes
  sudo_user: '{{mapr_admin_username}}'
  hadoop_properties:
    file: "/opt/mapr/oozie/oozie-{{oozie_version}}/conf/oozie-site.xml"
    name: "oozie.zookeeper.connection.string"
    value: "{{zookeepers.stdout|trim}}"
  notify: restart oozie

- name: update oozie namespace
  sudo: yes
  sudo_user: '{{mapr_admin_username}}'
  hadoop_properties:
    file: "/opt/mapr/oozie/oozie-{{oozie_version}}/conf/oozie-site.xml"
    name: "oozie.zookeeper.namespace"
    value: oozie
  notify: restart oozie

- name: update oozie-site.xml for impersonation (hosts)
  sudo: yes
  sudo_user: '{{mapr_admin_username}}'
  hadoop_properties:
    file: "/opt/mapr/oozie/oozie-{{oozie_version}}/conf/oozie-site.xml"
    name: 'oozie.service.ProxyUserService.proxyuser.mapr.hosts'
    value: '*'
  register: proxyuser_hosts
  notify: restart oozie

- name: update oozie-site.xml for impersonation (groups)
  sudo: yes
  sudo_user: '{{mapr_admin_username}}'
  hadoop_properties:
    file: "/opt/mapr/oozie/oozie-{{oozie_version}}/conf/oozie-site.xml"
    name: 'oozie.service.ProxyUserService.proxyuser.mapr.groups'
    value: '*'
  notify: restart oozie

- name: create tmp destination for oozie examples
  sudo: yes
  sudo_user: '{{mapr_admin_username}}'
  file: state=directory path="/tmp/oozie" mode=0755

- name: extract oozie examples
  sudo: yes
  sudo_user: '{{mapr_admin_username}}'
  unarchive: copy=no src=/opt/mapr/oozie/oozie-{{oozie_version}}/oozie-examples.tar.gz dest=/tmp/oozie

- name: create oozie/share/lib in dfs
  sudo: yes
  sudo_user: '{{mapr_admin_username}}'
  command: hadoop fs -mkdir -p /oozie/share/lib/examples

- pause: seconds=20

- name: copy oozie examples to cluster
  sudo: yes
  sudo_user: '{{mapr_admin_username}}'
  command: hadoop fs -copyFromLocal -f /tmp/oozie/examples /oozie/share/lib

#- name: extract oozie shared libs
#  shell: tar zxf /opt/mapr/oozie/oozie-{{oozie_version}}/oozie-sharelib*.tar.gz -C /mapr/{{cluster_name}}/oozie/share/lib
#  notify: reconfigure roles
